name: Update Rule Sets

on:
  schedule:
    - cron: '0 4 * * *' # Run every day at 4 AM UTC
  workflow_dispatch: # Manual run

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: pip install requests pyyaml

      - name: Install Sing-box
        run: |
          VERSION=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          echo "Installing sing-box v$VERSION"
          wget "https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/sing-box-${VERSION}-linux-amd64.tar.gz"
          tar -xzf "sing-box-${VERSION}-linux-amd64.tar.gz"
          sudo mv sing-box-${VERSION}-linux-amd64/sing-box /usr/local/bin/
          rm -rf sing-box*

      - name: Install Mihomo
        run: |
          # Mihomo uses pre-releases often, but let's try to get a recent compatible binary.
          # We filter for linux-amd64-compatible (often most stable) or just linux-amd64.
          # The API response structure for releases might vary, using a direct grep approach on the latest release assets.
          DOWNLOAD_URL=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | grep "browser_download_url" | grep "linux-amd64-compatible" | head -n 1 | cut -d '"' -f 4)
          
          # Fallback if compatible not found
          if [ -z "$DOWNLOAD_URL" ]; then
            DOWNLOAD_URL=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | grep "browser_download_url" | grep "linux-amd64" | head -n 1 | cut -d '"' -f 4)
          fi

          echo "Downloading Mihomo from $DOWNLOAD_URL"
          wget -O mihomo.gz "$DOWNLOAD_URL"
          gunzip mihomo.gz
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/

      - name: Run Conversion Script
        run: python scripts/convert.py

      - name: Push to release branch
        uses: s0/git-publish-subdir-action@develop
        env:
          REPO: self
          BRANCH: release
          FOLDER: releases
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MESSAGE: "chore: update rulesets [skip ci]"